# =============================================================================
# HydraDNS + Angular UI - Multi-stage Dockerfile (Embedded UI)
# =============================================================================

# Build Angular UI
ARG NODE_IMAGE=node:20-alpine
FROM ${NODE_IMAGE} AS ui-builder
WORKDIR /ui

# Copy Angular project (expects it under ui/hydradns)
# You can override UI_PROJECT via build-arg if your project name differs.
ARG UI_PROJECT=hydradns
COPY ui/${UI_PROJECT}/package*.json ./
RUN npm ci
COPY ui/${UI_PROJECT}/ ./
# Build production assets to /ui/dist
RUN npm run build -- --configuration production

# Build Go binary with embedded UI
FROM golang:1.24-alpine AS builder
WORKDIR /src

COPY go.mod go.sum ./
RUN go mod download

COPY cmd/ ./cmd/
COPY internal/ ./internal/
COPY docker/ ./docker/

# Copy built UI into the embed path expected by go:embed
# The Angular dist path is typically /ui/dist/<project-name>
ARG UI_PROJECT=hydradns
COPY --from=ui-builder /ui/dist/${UI_PROJECT}/ /src/internal/api/dist/

# Build with embedded UI (no -tags needed anymore)
RUN CGO_ENABLED=0 GOOS=linux go build -trimpath -ldflags="-s -w" -o /out/hydradns ./cmd/hydradns

# Runtime image
FROM alpine:3.21 AS runtime

ARG UID=1000
ARG GID=1000

RUN addgroup -g ${GID} hydradns && \
    adduser -D -u ${UID} -G hydradns -h /app -s /sbin/nologin hydradns && \
    apk add --no-cache ca-certificates && \
    rm -rf /var/cache/apk/* /tmp/*

ENV HYDRADNS_CONFIG=/app/config/hydradns.yaml \
    HYDRADNS_LOGGING_LEVEL=INFO

WORKDIR /app

COPY --from=builder /out/hydradns /app/hydradns

RUN mkdir -p /app/config && chown hydradns:hydradns /app/config
COPY --chown=hydradns:hydradns docker/hydradns.yaml /app/config/hydradns.yaml

RUN chmod 755 /app/hydradns && \
    chmod 644 /app/config/hydradns.yaml

EXPOSE 1053/udp
EXPOSE 1053/tcp
EXPOSE 8080/tcp

USER hydradns

CMD ["/app/hydradns"]
