# =============================================================================
# HydraDNS Docker Compose - Production Configuration
# =============================================================================
# Security-hardened deployment with proper resource limits and isolation

services:
  dns-server:
    build:
      context: .
      dockerfile: Dockerfile.ui
    image: hydradns:latest
    container_name: hydradns

    # Port mappings (UDP, TCP, and Web UI/API)
    ports:
      - "1053:1053/udp"
      - "1053:1053/tcp"
      - "8080:8080"      # Web UI + REST API

    # Environment variables
    environment:
      - HYDRADNS_DB=/data/hydradns.db
      - HYDRADNS_LOGGING_LEVEL=INFO
      # Rate limiting (set QPS to 0 to disable for benchmarking):
      # - HYDRADNS_RL_GLOBAL_QPS=0
      # - HYDRADNS_RL_PREFIX_QPS=0
      # - HYDRADNS_RL_IP_QPS=0

    # Volume mounts
    volumes:
      - hydradns-data:/data

    # Restart policy
    restart: unless-stopped

    # =========================================================================
    # Security Hardening
    # =========================================================================

    # Run as non-root user (matches Dockerfile USER)
    user: "1000:1000"

    # Security options
    security_opt:
      # Disable privilege escalation
      - no-new-privileges:true

    # Drop all capabilities, add only what's needed
    cap_drop:
      - ALL
    # Uncomment if binding to port < 1024:
    # cap_add:
    #   - NET_BIND_SERVICE

    # Read-only root filesystem (defense in depth)
    read_only: true

    # Tmpfs for writable directories (if needed)
    # noexec,nosuid prevents execution from /tmp and setuid binaries
    tmpfs:
      - /tmp:size=10M,mode=1777,noexec,nosuid

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "6"
          memory: 1024M
        reservations:
          cpus: "6"
          memory: 1024M

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  hydradns-data:
