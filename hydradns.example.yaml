# HydraDNS Configuration File
#
# This is an example configuration file for HydraDNS.
# Copy this file to hydradns.yaml and customize as needed.
#
# Configuration priority:
#   1. Command-line arguments (--port, --host, etc.)
#   2. Environment variables
#   3. YAML config file
#   4. Default values
#
# Environment variable naming pattern: HYDRADNS_<SECTION>_<KEY>
# Examples:
#   server.host        -> HYDRADNS_SERVER_HOST
#   server.port        -> HYDRADNS_SERVER_PORT
#   server.enable_tcp  -> HYDRADNS_SERVER_ENABLE_TCP
#   upstream.servers   -> HYDRADNS_UPSTREAM_SERVERS
#   logging.level      -> HYDRADNS_LOGGING_LEVEL
#   filtering.enabled  -> HYDRADNS_FILTERING_ENABLED

# Server configuration
server:
  # Address to bind to (default: 0.0.0.0)
  host: "0.0.0.0"

  # Port to listen on for both UDP and TCP (default: 1053)
  port: 1053

  # Number of worker processes
  # - "auto" or omit: auto-detect based on available CPUs
  # - number: specific number of workers
  workers: auto

  # Maximum concurrent requests per worker (default: auto-calculated)
  # max_concurrency: 2048

  # Size of upstream socket pool per worker (default: auto-calculated)
  # upstream_socket_pool_size: 256

  # Enable TCP server alongside UDP (default: true)
  # TCP is used for:
  #   - Responses larger than 512 bytes
  #   - Clients that prefer TCP
  #   - Zone transfers (future)
  enable_tcp: true

  # Enable automatic TCP fallback for truncated upstream responses (default: true)
  # When a UDP response from upstream has the TC (truncated) bit set,
  # automatically retry the query over TCP
  tcp_fallback: true

# Upstream DNS servers for forwarding (strict-order failover)
# Primary is always tried first. Fallbacks used only if primary fails.
# Failed servers are automatically retried after 1 hour.
# Maximum 3 servers. Port is always 53.
upstream:
  servers:
    - "9.9.9.9"   # Primary: Quad9 (privacy-focused, malware blocking)
    - "1.1.1.1"   # Fallback 1: Cloudflare (fast, privacy-focused)
    - "8.8.8.8"   # Fallback 2: Google (reliable)

  # Timeout for UDP queries to upstream servers (default: 3s)
  udp_timeout: "3s"

  # Timeout for TCP queries to upstream servers (default: 5s)
  tcp_timeout: "5s"

  # Maximum retries per upstream on timeout before failing over (default: 3)
  max_retries: 3

# Zone file configuration
zones:
  # Directory to scan for zone files (default: zones)
  # All files in this directory will be loaded as zone files
  directory: "zones"

  # Specific zone files to load (optional)
  # If specified, only these files are loaded (directory is ignored)
  # files:
  #   - "/etc/hydradns/zones/example.com.zone"
  #   - "/etc/hydradns/zones/internal.zone"

# Logging configuration
logging:
  # Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL (default: INFO)
  level: "INFO"

  # Structured logging (for log aggregation systems like ELK, Splunk, Datadog)
  # When enabled, logs are output in machine-parseable format
  structured: false

  # Structured format type: "json" or "keyvalue" (default: json)
  # - json: Single-line JSON objects {"timestamp": "...", "level": "INFO", ...}
  # - keyvalue: Space-separated key=value pairs
  structured_format: "json"

  # Include process ID in structured logs (useful for multiprocess deployments)
  include_pid: false

  # Extra static fields to include in every structured log entry
  # Useful for adding service metadata for log aggregation
  # extra_fields:
  #   service: "hydradns"
  #   environment: "production"
  #   datacenter: "us-east-1"

# Domain filtering configuration (ad blocking, malware protection)
filtering:
  # Enable domain filtering (default: false)
  enabled: false

  # Log blocked queries (default: true)
  log_blocked: true

  # Log allowed queries (verbose, default: false)
  log_allowed: false

  # Custom whitelist domains (always allowed, takes priority over blacklist)
  # Wildcards all subdomains automatically
  whitelist_domains:
    - "safe.example.com"
    - "allowed.ads.com"

  # Custom blacklist domains (always blocked)
  # Wildcards all subdomains automatically
  blacklist_domains:
    - "ads.example.com"
    - "tracker.example.com"

  # Remote blocklists to fetch and merge (loaded on startup, refreshed periodically)
  # Supports multiple formats: adblock, hosts, domains, or auto-detect
  blocklists:
    # Hagezi Light - balanced ad blocking with minimal false positives
    - name: "hagezi-light"
      url: "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/adblock/light.txt"
      format: "adblock"
    # StevenBlack hosts file - ads + malware
    # - name: "stevenblack"
    #   url: "https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts"
    #   format: "hosts"

  # How often to refresh remote blocklists (default: 24h)
  refresh_interval: "24h"

# Rate limiting configuration (3-tier token bucket)
# Rate limiting is applied before query parsing to minimize CPU overhead.
# Requests must pass all three tiers: global -> prefix (/24 IPv4, /64 IPv6) -> IP
# Set QPS values to 0 to disable that tier.
rate_limit:
  # Stale entry cleanup interval in seconds (default: 60)
  cleanup_seconds: 60

  # Maximum tracked entries (memory usage control)
  max_ip_entries: 65536      # Max tracked IP addresses
  max_prefix_entries: 16384  # Max tracked network prefixes

  # Global rate limit (server-wide)
  global_qps: 100000   # Queries per second (0 = disabled)
  global_burst: 100000 # Burst allowance

  # Per-prefix rate limit (/24 for IPv4, /64 for IPv6)
  prefix_qps: 10000    # Queries per second per prefix
  prefix_burst: 20000  # Burst allowance

  # Per-IP rate limit
  ip_qps: 5000         # Queries per second per IP
  ip_burst: 10000      # Burst allowance

# REST API configuration
# The API provides runtime management and monitoring via HTTP.
# Swagger UI available at http://<host>:<port>/swagger/index.html
api:
  # Enable the REST API (default: false)
  enabled: false

  # Address to bind the API server to (default: 127.0.0.1)
  # Use 0.0.0.0 to allow external access (not recommended without api_key)
  host: "127.0.0.1"

  # Port for the API server (default: 8080)
  port: 8080

  # API key for authentication (optional)
  # If set, all API requests must include X-API-Key header
  # Leave empty to disable authentication (only for trusted networks)
  api_key: ""